<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <title>身材吃豆人 (Pro Max)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        [v-cloak] { display: none; }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* --- 吃豆人样式 --- */
        .pac-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; width: 100%; max-width: 340px; margin: 0 auto; }
        .pac-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 4px; transition: all 0.3s; }
        .pac-cell.eaten { background-color: #ffedd5; }
        .dot { width: 5px; height: 5px; background-color: #cbd5e1; border-radius: 50%; }
        .pacman { width: 20px; height: 20px; border-radius: 50%; position: relative; z-index: 10; transform: rotate(90deg); animation: chomp 0.3s infinite alternate linear; }
        @keyframes chomp { 0% { background: conic-gradient(transparent 30deg, #f59e0b 30deg, #f59e0b 330deg, transparent 330deg); } 100% { background: conic-gradient(transparent 0deg, #f59e0b 0deg, #f59e0b 360deg, transparent 360deg); } }
        
        .input-light { background: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; }
        .input-light:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* 海报专用样式 */
        .poster-container {
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            width: 375px; 
            padding: 30px;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: absolute;
            left: -9999px;
            top: 0;
            color: #334155;
        }
    </style>
</head>
<body class="pb-safe">

<div id="app" v-cloak class="min-h-screen p-3 sm:p-6 max-w-7xl mx-auto pb-24 pt-safe">
    
    <div v-if="msg" class="fixed top-6 left-1/2 -translate-x-1/2 z-[80] px-6 py-3 rounded-full shadow-xl text-sm font-bold flex items-center gap-2 border border-white/20 animate-bounce"
         :class="msgType === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-500 text-white'">
        <i class="fas" :class="msgType === 'success' ? 'fa-check' : 'fa-exclamation-circle'"></i> {{ msg }}
    </div>

    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
            <div class="text-amber-500 text-2xl"><i class="fas fa-ghost"></i></div>
            <h1 class="text-lg font-black text-slate-800">身材吃豆人</h1>
        </div>
        <div class="flex gap-2">
            <button @click="generatePoster" class="bg-indigo-500 text-white w-9 h-9 rounded-lg shadow-sm flex items-center justify-center hover:bg-indigo-600 transition active:scale-95">
                <i class="fas fa-camera"></i>
            </button>
            
            <input type="file" ref="fileInput" @change="handleExcelUpload" accept=".xlsx,.xls,.csv" class="hidden">
            <button @click="$refs.fileInput.click()" class="bg-white w-9 h-9 rounded-lg border border-slate-200 text-slate-400 shadow-sm flex items-center justify-center"><i class="fas fa-upload"></i></button>
            <button @click="showConfig=true" class="bg-white w-9 h-9 rounded-lg border border-slate-200 text-slate-400 shadow-sm flex items-center justify-center"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div ref="posterArea" class="poster-container">
        <div class="text-amber-500 text-4xl mb-2"><i class="fas fa-ghost"></i></div>
        <h2 class="text-2xl font-black text-slate-800 mb-1">我的减重日记</h2>
        <div class="text-sm text-slate-500 mb-6 uppercase tracking-widest">{{ new Date().toISOString().split('T')[0] }}</div>
        
        <div class="bg-white/60 backdrop-blur rounded-2xl p-6 w-full shadow-lg border border-white/50 mb-6">
            <div class="flex justify-between w-full mb-4 px-1 text-[10px] text-slate-500 font-bold border-b border-slate-300/30 pb-2">
                <div>初始: {{ (config.start * 2).toFixed(1) }}斤 (0%)</div>
                <div>目标: {{ (config.target * 2).toFixed(1) }}斤 (100%)</div>
            </div>

            <div class="flex justify-between items-end mb-4">
                <div>
                    <div class="text-xs text-slate-400 font-bold uppercase">Current</div>
                    <div class="text-5xl font-black text-slate-800 tracking-tighter">{{ (currentWeight * 2).toFixed(1) }}<span class="text-lg text-slate-400 ml-1">斤</span></div>
                </div>
                <div class="text-right">
                    <div class="text-indigo-600 font-black text-2xl">{{ lostJin }} <span class="text-sm">斤</span></div>
                    <div class="text-xs text-slate-400 font-bold uppercase">Total Lost</div>
                </div>
            </div>
            
            <div class="pac-grid mb-2">
                <div v-for="n in 100" :key="n" class="pac-cell" :style="{backgroundColor: n < currentStep ? '#ffedd5' : '#f1f5f9'}">
                    <div v-if="n === currentStep" class="pacman" style="width:16px;height:16px;"></div>
                    <div v-else-if="n > currentStep" class="dot"></div>
                </div>
            </div>
            <div class="text-center mt-2 text-xs font-bold text-slate-400">进度 {{ currentStep }}%</div>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full">
            <div class="bg-white/60 rounded-xl p-4 text-center shadow-sm">
                <div class="text-2xl font-black text-slate-700">{{ timeStats.daysSpent }}</div>
                <div class="text-[10px] text-slate-400 font-bold uppercase">坚持天数</div>
            </div>
            <div class="bg-white/60 rounded-xl p-4 text-center shadow-sm">
                <div class="text-2xl font-black text-slate-700">¥{{ stats.totalCost }}</div>
                <div class="text-[10px] text-slate-400 font-bold uppercase">减肥投入</div>
            </div>
        </div>
        
        <div class="mt-8 text-[10px] text-slate-400 font-medium flex items-center gap-1">
            <i class="fas fa-qrcode"></i> Shape Pac-Man
        </div>
    </div>

    <div v-if="showPosterModal" class="fixed inset-0 z-[70] bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center p-6" @click.self="showPosterModal=false">
        <div class="relative max-w-sm w-full">
            <button @click="showPosterModal=false" class="absolute -top-10 right-0 text-white/80 hover:text-white text-xl"><i class="fas fa-times"></i></button>
            <div class="bg-white rounded-2xl overflow-hidden shadow-2xl">
                <img :src="posterImage" class="w-full h-auto block" alt="Share Poster">
            </div>
            <p class="text-center text-white/70 text-sm mt-4 font-medium animate-pulse">
                <i class="fas fa-hand-pointer"></i> 长按图片保存或分享
            </p>
        </div>
    </div>

    <div v-if="showConfig" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="showConfig=false">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">⚙️ 设置</h3>
                <button @click="showConfig=false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400">GitHub Token</label><input type="password" v-model="config.token" class="w-full input-light rounded-lg px-3 py-2 text-xs font-mono mt-1"></div>
                <div><label class="text-xs font-bold text-slate-400">Gist ID</label><input type="text" v-model="config.gistId" @blur="cleanGistId" class="w-full input-light rounded-lg px-3 py-2 text-xs font-mono mt-1"></div>
                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div><label class="text-xs font-bold text-slate-400">初始(kg)</label><input type="number" v-model.number="config.start" class="w-full input-light rounded-lg px-2 py-1 mt-1 text-sm font-bold"></div>
                    <div><label class="text-xs font-bold text-slate-400">目标(kg)</label><input type="number" v-model.number="config.target" class="w-full input-light rounded-lg px-2 py-1 mt-1 text-sm font-bold text-indigo-600"></div>
                </div>
                <div class="flex gap-2 pt-2 border-t border-slate-100 mt-2">
                    <button @click="pullData" :disabled="loading" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">拉取</button>
                    <button @click="saveConfigAndPush" :disabled="loading" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg text-xs font-bold shadow-md transition flex items-center justify-center gap-2">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
        
        <div class="lg:col-span-4 flex flex-col gap-5">
            <div class="glass rounded-2xl p-5 border-t-4 border-amber-400 relative overflow-hidden">
                <div class="flex justify-between items-baseline mb-2">
                    <div class="text-4xl font-black text-slate-800">{{ (currentWeight * 2).toFixed(1) }}<span class="text-sm font-normal text-slate-400 ml-1">斤</span></div>
                    <div class="text-indigo-600 font-bold text-lg text-xs">{{ currentWeight }} kg</div>
                </div>
                <div class="pac-grid mb-4">
                    <div v-for="n in 100" :key="n" class="pac-cell" :class="{'eaten': n < currentStep}">
                        <div v-if="n === currentStep" class="pacman"></div>
                        <div v-else-if="n === 100" class="fas fa-flag-checkered text-rose-500 text-xs"></div>
                        <div v-else-if="n > currentStep" class="dot"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div class="bg-emerald-50 rounded-lg p-2">
                        <div class="text-emerald-600 font-black text-lg">{{ lostJin }}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">已减 (斤)</div>
                    </div>
                    <div class="bg-rose-50 rounded-lg p-2">
                        <div class="text-rose-500 font-black text-lg">{{ remainJin }}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">剩余 (斤)</div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-4">
                <div class="grid grid-cols-2 gap-4 mb-4 border-b border-slate-100 pb-4">
                    <div><div class="text-xs text-slate-400 font-bold mb-1"><i class="far fa-clock"></i> 已记录</div><div class="text-slate-700 font-black text-lg">{{ timeStats.daysSpent }} <span class="text-xs font-normal">天</span></div></div>
                    <div><div class="text-xs text-slate-400 font-bold mb-1"><i class="fas fa-hourglass-half"></i> 预计剩余</div><div class="font-black text-lg" :class="timeStats.daysRemaining === '∞' ? 'text-slate-300' : 'text-indigo-600'">{{ timeStats.daysRemaining }} <span class="text-xs font-normal" v-if="timeStats.daysRemaining !== '∞'">天</span></div></div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><div class="text-slate-800 font-bold">¥{{ stats.totalCost }}</div><div class="text-[10px] text-slate-400">总花费</div></div>
                    <div><div class="text-slate-800 font-bold">¥{{ stats.avgCost }}</div><div class="text-[10px] text-slate-400">日均</div></div>
                    <div><div class="text-amber-500 font-bold">¥{{ stats.costPerJin }}</div><div class="text-[10px] text-slate-400">每斤单价</div></div>
                </div>
            </div>

            <div class="glass rounded-2xl p-5 shadow-lg relative z-10">
                <h3 class="text-xs font-bold text-slate-500 mb-3 uppercase">记录今日</h3>
                <div class="space-y-3">
                    <input type="date" v-model="input.date" class="w-full input-light rounded-lg px-3 py-2 text-sm font-bold">
                    <div class="flex gap-2">
                        <input type="number" v-model.number="input.weight" placeholder="体重 kg" step="0.1" class="flex-1 input-light rounded-lg px-3 py-2 text-sm font-bold">
                        <input type="number" v-model.number="input.cost" placeholder="¥ 花费" class="flex-1 input-light rounded-lg px-3 py-2 text-sm font-bold">
                    </div>
                    <input type="text" v-model="input.note" @keyup.enter="addRecord" placeholder="备注..." class="w-full input-light rounded-lg px-3 py-2 text-sm">
                    <button @click="addRecord" :disabled="loading" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition flex justify-center items-center gap-2 shadow-xl shadow-slate-200 active:scale-[0.98]">
                        <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> 同步中...</span><span v-else>打卡记录</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 flex flex-col gap-4">
            <div class="glass rounded-xl p-3 flex flex-col sm:flex-row gap-3 items-center justify-between">
                <div class="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                    <i class="fas fa-sync-alt" :class="{'text-indigo-500 fa-spin': isZooming}"></i> {{ isZooming ? '缩放中...' : '图表联动' }}
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <input type="date" v-model="filter.start" @change="updateChartZoom" class="input-light rounded-lg px-2 py-1 text-xs font-bold text-slate-600 flex-1">
                    <span class="text-slate-300">-</span>
                    <input type="date" v-model="filter.end" @change="updateChartZoom" class="input-light rounded-lg px-2 py-1 text-xs font-bold text-slate-600 flex-1">
                    <button @click="resetZoom" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold px-2">重置</button>
                </div>
            </div>

            <div class="glass rounded-2xl p-4 h-[350px] relative">
                <div id="chart" class="w-full h-full"></div>
                <div v-if="chartData.length === 0" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm">暂无数据</div>
            </div>

            <div class="glass rounded-2xl overflow-hidden flex flex-col h-[500px]">
                <div class="p-3 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500">记录明细</span>
                    <span class="text-[10px] bg-white border px-2 py-0.5 rounded text-slate-400">{{ tableData.length }} 条</span>
                </div>
                <div class="overflow-auto custom-scroll flex-1 p-2">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-400 sticky top-0 bg-white z-10">
                            <tr>
                                <th class="pb-2 pl-2">日期</th><th class="pb-2">体重(斤)</th><th class="pb-2">变化</th><th class="pb-2">总变</th><th class="pb-2">费</th><th class="pb-2 hidden sm:table-cell">注</th><th class="pb-2"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            <tr v-for="r in tableData" :key="r.date" class="hover:bg-slate-50/50">
                                <td class="py-2.5 pl-2 font-mono text-xs">{{ r.date.substring(5) }}</td>
                                <td class="py-2.5 font-bold">{{ (r.weight*2).toFixed(1) }}</td>
                                <td class="py-2.5 text-xs">
                                    <span v-if="r.dailyDiff !== null" :class="r.dailyDiff<=0?'text-emerald-500':'text-rose-500'">{{ r.dailyDiff<=0?'↓':'↑' }}{{ Math.abs(r.dailyDiff).toFixed(1) }}</span>
                                    <span v-else class="text-slate-200">-</span>
                                </td>
                                <td class="py-2.5"><span class="px-1.5 py-0.5 rounded text-[10px] font-bold" :class="getDiffColor(r.weight)">{{ getDiffTextJin(r.weight) }}</span></td>
                                <td class="py-2.5 text-xs text-slate-400">{{ r.cost > 0 ? '¥'+r.cost : '-' }}</td>
                                <td class="py-2.5 text-xs text-slate-400 hidden sm:table-cell max-w-[100px] truncate">{{ r.note }}</td>
                                <td class="py-2.5 text-right pr-2"><button @click="deleteRecord(r)" class="text-slate-300 hover:text-rose-500"><i class="fas fa-times"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            loading: false, showConfig: false, msg: '', msgType: 'info', isZooming: false,
            // 海报相关
            showPosterModal: false, posterImage: '',
            config: { token: '', gistId: '', start: 80, target: 65 },
            input: { date: new Date().toISOString().split('T')[0], weight: '', cost: '', note: '' },
            filter: { start: '', end: '' },
            records: [],
            chart: null
        }
    },
    computed: {
        sortedRawRecords() { return [...this.records].sort((a, b) => new Date(a.date) - new Date(b.date)); },
        fullContinuosData() {
            if (this.sortedRawRecords.length === 0) return [];
            const recordsMap = new Map(); this.sortedRawRecords.forEach(r => recordsMap.set(r.date, r));
            const start = new Date(this.sortedRawRecords[0].date);
            const end = new Date(this.sortedRawRecords[this.sortedRawRecords.length - 1].date);
            const result = [];
            let lastKnown = { weight: this.sortedRawRecords[0].weight, cost: parseFloat(this.sortedRawRecords[0].cost) || 0 };

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const existing = recordsMap.get(dateStr);
                if (existing) {
                    lastKnown = { weight: parseFloat(existing.weight), cost: parseFloat(existing.cost) || 0 };
                    result.push({ ...existing, weight: lastKnown.weight, filledCost: lastKnown.cost, isAuto: false });
                } else {
                    result.push({ date: dateStr, weight: lastKnown.weight, cost: 0, filledCost: lastKnown.cost, note: '', isAuto: true });
                }
            }
            return result.map((curr, idx) => {
                let dailyDiff = null;
                if (idx > 0) dailyDiff = (curr.weight - result[idx - 1].weight) * 2;
                return { ...curr, dailyDiff };
            });
        },
        chartData() { return this.fullContinuosData; },
        displayedRecords() {
            let data = this.fullContinuosData;
            if (this.filter.start) data = data.filter(r => r.date >= this.filter.start);
            if (this.filter.end) data = data.filter(r => r.date <= this.filter.end);
            return data;
        },
        tableData() { return this.displayedRecords.filter(r => !r.isAuto).reverse(); },
        currentWeight() { const data = this.fullContinuosData; return data.length ? data[data.length-1].weight : this.config.start; },
        lostJin() { return ((this.config.start - this.currentWeight) * 2).toFixed(1); },
        remainJin() { let v = (this.currentWeight - this.config.target) * 2; return v > 0 ? v.toFixed(1) : 0; },
        currentStep() {
            const total = this.config.start - this.config.target; const lost = this.config.start - this.currentWeight;
            if(total <= 0) return 100; return Math.floor(Math.min(100, Math.max(0, (lost / total) * 100)));
        },
        stats() {
            const data = this.displayedRecords; 
            if (data.length === 0) return { totalCost: 0, avgCost: 0, costPerJin: 0 };
            const totalCost = data.reduce((sum, r) => sum + r.filledCost, 0);
            const avgCost = (totalCost / data.length).toFixed(1);
            const startW = data[0].weight; const endW = data[data.length-1].weight;
            const lostInPeriod = (startW - endW) * 2;
            let costPerJin = lostInPeriod > 0 ? (totalCost / lostInPeriod).toFixed(1) : "∞";
            return { totalCost: totalCost.toFixed(0), avgCost: avgCost, costPerJin: costPerJin };
        },
        timeStats() {
            const data = this.fullContinuosData;
            if (data.length < 1) return { daysSpent: 0, daysRemaining: '∞' };
            const daysSpent = data.length;
            const totalLost = this.config.start - this.currentWeight;
            let daysRemaining = '∞';
            if (totalLost > 0 && daysSpent > 0) {
                const ratePerDay = totalLost / daysSpent; 
                const remainingKg = this.currentWeight - this.config.target;
                daysRemaining = remainingKg > 0 ? Math.ceil(remainingKg / ratePerDay) : 0;
            }
            return { daysSpent, daysRemaining };
        }
    },
    watch: {
        chartData: { handler() { this.initChart(); }, deep: true }
    },
    mounted() {
        const saved = localStorage.getItem('pacman_config');
        if(saved) { try { this.config = { ...this.config, ...JSON.parse(saved) }; } catch(e){} }
        if(this.config.token && this.config.gistId) { this.pullData(); } else { this.showConfig = true; }
        window.addEventListener('resize', () => this.chart && this.chart.resize());
    },
    methods: {
        notify(text, type='success') { this.msg = text; this.msgType = type; setTimeout(() => this.msg = '', 3000); },
        saveToLocal() { localStorage.setItem('pacman_config', JSON.stringify({ token: this.config.token, gistId: this.config.gistId, start: this.config.start, target: this.config.target })); },
        cleanGistId() { if(this.config.gistId.includes('/')) { this.config.gistId = this.config.gistId.split('/').pop(); } this.saveToLocal(); },
        async saveConfigAndPush() { this.saveToLocal(); this.showConfig = false; this.notify('配置已保存'); },
        
        async generatePoster() {
            this.loading = true;
            try {
                const el = this.$refs.posterArea;
                const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
                this.posterImage = canvas.toDataURL("image/png");
                this.showPosterModal = true;
                this.notify('海报生成成功');
            } catch(e) {
                console.error(e);
                this.notify('生成海报失败', 'error');
            } finally {
                this.loading = false;
            }
        },

        async pullData() {
            if(!this.config.token || !this.config.gistId) { this.notify('请先完善配置', 'error'); return; }
            this.loading = true; this.saveToLocal();
            try {
                const res = await fetch(`https://api.github.com/gists/${this.config.gistId}`, { headers: { 'Authorization': `token ${this.config.token}` } });
                if(!res.ok) throw new Error(`Code: ${res.status}`);
                const data = await res.json();
                const content = JSON.parse(data.files['data.json'].content);
                this.records = Array.isArray(content) ? content : content.records;
                if(content.meta) { this.config.start = content.meta.start; this.config.target = content.meta.target; }
                this.showConfig = false; this.notify('同步成功');
            } catch(e) { this.notify(e.message, 'error'); this.showConfig = true; } finally { this.loading = false; }
        },
        async pushData() {
            this.loading = true; this.saveToLocal();
            try {
                const payload = { files: { "data.json": { content: JSON.stringify({ meta: { start: this.config.start, target: this.config.target }, records: this.records })}} };
                await fetch(`https://api.github.com/gists/${this.config.gistId}`, { method: 'PATCH', headers: { 'Authorization': `token ${this.config.token}` }, body: JSON.stringify(payload) });
                this.notify('已上传');
            } catch(e) { this.notify(e.message, 'error'); } finally { this.loading = false; }
        },
        handleExcelUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const wb = XLSX.read(ev.target.result, {type:'binary'});
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const map = new Map(); this.records.forEach(x => map.set(x.date, x));
                rows.forEach(row => {
                    let d, w, c, n;
                    for(let k in row) {
                        let lk = k.toLowerCase();
                        if(lk.includes('date') || lk.includes('日期')) d = this.parseExcelDate(row[k]);
                        if(lk.includes('weight') || lk.includes('体重')) w = row[k];
                        if(lk.includes('cost') || lk.includes('花费')) c = row[k];
                        if(lk.includes('note') || lk.includes('备注')) n = row[k];
                    }
                    if(d && w) map.set(d, { date: d, weight: w, cost: c||0, note: n||'' });
                });
                this.records = Array.from(map.values());
                this.pushData(); this.notify('导入成功');
            };
            r.readAsBinaryString(f);
        },
        parseExcelDate(val) {
            if(!val) return null;
            if(typeof val === 'number') return new Date((val - 25569)*86400000).toISOString().split('T')[0];
            return new Date(val).toISOString().split('T')[0];
        },
        async addRecord() {
            if(!this.input.weight) return;
            const idx = this.records.findIndex(r => r.date === this.input.date);
            const rec = { ...this.input, cost: this.input.cost || 0 };
            if(idx > -1) this.records[idx] = rec; else this.records.push(rec);
            this.input.note = ''; await this.pushData();
        },
        deleteRecord(r) { if(confirm('删除?')) { this.records = this.records.filter(i => i.date !== r.date); this.pushData(); } },
        getDiffTextJin(w) { const d = (w - this.config.start)*2; return d > 0 ? `+${d.toFixed(1)}` : d.toFixed(1); },
        getDiffColor(w) { return w < this.config.start ? 'text-emerald-600 bg-emerald-100' : 'text-rose-500 bg-rose-100'; },

        updateChartZoom() {
            if(!this.chart || !this.filter.start || !this.filter.end) return;
            this.chart.dispatchAction({ type: 'dataZoom', startValue: this.filter.start, endValue: this.filter.end });
        },
        resetZoom() {
            if(!this.chart) return;
            this.chart.dispatchAction({ type: 'dataZoom', start: 0, end: 100 });
            this.filter.start = ''; this.filter.end = '';
        },
        initChart() {
            const dom = document.getElementById('chart');
            if(!dom) return;
            if(this.chart) this.chart.dispose();
            this.chart = echarts.init(dom);
            const data = this.chartData;

            this.chart.setOption({
                grid: { top: 40, right: 10, bottom: 80, left: 45 }, // left增加，留给斤的刻度
                dataZoom: [
                    { type: 'inside', start: 0, end: 100 },
                    { type: 'slider', bottom: 10, height: 30, handleSize: '120%', dataBackground: { lineStyle: { color: '#cbd5e1' }, areaStyle: { color: '#f1f5f9' } } }
                ],
                tooltip: { 
                    trigger: 'axis', backgroundColor: 'rgba(255,255,255,0.95)',
                    formatter: p => {
                        const i = data[p[0].dataIndex];
                        let html = `<div class="font-bold mb-1 flex justify-between gap-4"><span>${i.date}</span> ${i.isAuto ? '<span class="text-[10px] text-amber-500 bg-amber-50 px-1 rounded">自动</span>' : ''}</div>`;
                        // Tooltip 强调斤
                        html += `<div>体重: <b class="text-indigo-600">${(i.weight*2).toFixed(1)}斤</b> <span class="text-slate-400 text-xs">(${i.weight}kg)</span></div>`;
                        html += `<div class="text-xs text-slate-500 mt-1">费用: ¥${i.filledCost}</div>`;
                        if(i.note && !i.isAuto) html += `<div class="text-xs text-slate-400 mt-1 pt-1 border-t">${i.note}</div>`;
                        return html;
                    }
                },
                xAxis: { type: 'category', data: data.map(r => r.date), axisLine: { lineStyle: { color: '#e2e8f0' } } },
                yAxis: { 
                    type: 'value', 
                    scale: true, 
                    splitLine: { lineStyle: { color: '#f1f5f9' } },
                    // Y轴改用斤
                    axisLabel: { formatter: (val) => (val*2).toFixed(0) + '斤', color: '#94a3b8', fontSize: 10 }
                },
                series: [{
                    data: data.map(r => r.weight),
                    type: 'line', smooth: true,
                    symbol: (val, params) => data[params.dataIndex].isAuto ? 'none' : 'circle', 
                    symbolSize: 6, itemStyle: { color: '#6366f1' }, lineStyle: { width: 3 },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(99,102,241,0.2)'},{offset:1,color:'rgba(99,102,241,0)'}]) },
                    // 添加参考线
                    markLine: {
                        symbol: ['none', 'none'],
                        label: { show: true, position: 'insideEndTop', fontSize: 10 },
                        data: [
                            { 
                                yAxis: this.config.start, 
                                label: { formatter: p => `初始 ${(p.value*2).toFixed(1)}斤 (0%)`, color: '#64748b' }, 
                                lineStyle: { color: '#94a3b8', type: 'dotted' } 
                            },
                            { 
                                yAxis: this.config.target, 
                                label: { formatter: p => `目标 ${(p.value*2).toFixed(1)}斤 (100%)`, color: '#10b981' }, 
                                lineStyle: { color: '#10b981', width: 2 } 
                            }
                        ]
                    }
                }]
            });
            this.chart.on('dataZoom', (params) => {
                this.isZooming = true;
                const option = this.chart.getOption();
                const axisData = option.xAxis[0].data;
                const startPercent = params.start != null ? params.start : option.dataZoom[0].start;
                const endPercent = params.end != null ? params.end : option.dataZoom[0].end;
                const startIndex = Math.floor(startPercent / 100 * (axisData.length - 1));
                const endIndex = Math.ceil(endPercent / 100 * (axisData.length - 1));
                this.filter.start = axisData[startIndex]; this.filter.end = axisData[endIndex];
                setTimeout(() => this.isZooming = false, 500);
            });
        }
    }
}).mount('#app');
</script>
</body>
</html>
