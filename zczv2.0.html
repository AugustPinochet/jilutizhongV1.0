<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«æèœ•å˜ä¸æˆæœ¬è¿½è¸ª Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f1f5f9; }
        [v-cloak] { display: none !important; }
        
        /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        /* è‚Œè‚‰çº¿æ¡åŠ¨ç”» */
        .muscle-reveal-enter-active, .muscle-reveal-leave-active { transition: opacity 1s ease; }
        
        /* æŒ‰é’®åŠ¨æ•ˆ */
        .btn-click:active { transform: scale(0.96); }

        /* èº«ä½“æ¨¡å‹å®¹å™¨ */
        .body-container {
            position: relative;
            height: 240px;
            width: 140px;
            margin: 0 auto;
        }
        .body-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-slate-700">

<div id="app" v-cloak class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                <i class="fas fa-dumbbell mr-2 text-blue-600"></i>èº«æèœ•å˜è¿½è¸ª
            </h1>
            <p class="text-slate-500 mt-1 text-sm">çœ‹ç€å¤šä½™çš„è„‚è‚ªä¸€ç‚¹ç‚¹æ¶ˆå¤±</p>
        </div>
        <div class="flex flex-wrap gap-2 justify-center md:justify-end">
            <button @click="downloadTemplate" class="btn-click px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg shadow-sm hover:bg-slate-50 text-sm transition">
                <i class="fas fa-download mr-1"></i> æ¨¡æ¿
            </button>
            <label class="btn-click px-3 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 text-sm transition cursor-pointer flex items-center">
                <i class="fas fa-file-import mr-1"></i> å¯¼å…¥ Excel
                <input type="file" @change="importExcel" class="hidden" accept=".xlsx, .xls">
            </label>
            <button @click="resetData" class="btn-click px-3 py-2 bg-rose-50 text-rose-600 border border-rose-100 rounded-lg hover:bg-rose-100 text-sm transition">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- å·¦ä¾§ï¼šè®¾ç½®ä¸å½•å…¥ (å 4åˆ—) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- 1. åŸºç¡€è®¾å®š -->
            <div class="glass-panel rounded-2xl p-5">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">ğŸ¯ ç›®æ ‡è®¾å®š</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">åˆå§‹ (KG)</label>
                        <input type="number" v-model.number="settings.initialWeight" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-200 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">ç›®æ ‡ (KG)</label>
                        <input type="number" v-model.number="settings.targetWeight" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-200 outline-none">
                    </div>
                </div>
                <button @click="saveSettings" class="btn-click w-full bg-slate-800 text-white text-sm py-2 rounded-lg hover:bg-slate-700 transition">
                    ä¿å­˜è®¾å®š
                </button>
            </div>

            <!-- 2. æ¯æ—¥æ‰“å¡ -->
            <div class="glass-panel rounded-2xl p-5 border-t-4 border-indigo-500">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <i class="fas fa-pen-fancy text-indigo-500 mr-2"></i> ä»Šæ—¥è®°å½•
                </h3>
                <form @submit.prevent="addRecord" class="space-y-4">
                    <input type="date" v-model="newRecord.date" required class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-400">ä½“é‡ (KG)</label>
                            <input type="number" step="0.01" v-model.number="newRecord.weight" required placeholder="0.0" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-indigo-500 font-bold text-slate-700">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">èŠ±è´¹ (å…ƒ)</label>
                            <input type="number" step="0.1" v-model.number="newRecord.cost" placeholder="0" class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 outline-none focus:border-indigo-500">
                        </div>
                    </div>
                    <button type="submit" class="btn-click w-full bg-gradient-to-r from-indigo-600 to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition">
                        æ‰“å¡
                    </button>
                </form>
            </div>

            <!-- 3. ç»æµè´¦ -->
            <div class="glass-panel rounded-2xl p-5 flex justify-between items-center">
                <div>
                    <p class="text-xs text-slate-500">ç´¯è®¡æŠ•å…¥</p>
                    <p class="text-2xl font-bold text-slate-800">Â¥{{ totalCost.toLocaleString() }}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-slate-500">æ¯æ–¤æˆæœ¬</p>
                    <p class="text-xl font-bold text-amber-500">Â¥{{ costPerJin }}</p>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šå¯è§†åŒ–æ¨¡å‹ (å 4åˆ—) -->
        <div class="lg:col-span-4 flex flex-col gap-6">
            <div class="glass-panel rounded-2xl p-6 flex-1 flex flex-col items-center justify-center relative overflow-hidden bg-gradient-to-b from-white to-slate-50">
                <h3 class="text-lg font-bold text-slate-800 mb-2">èº«æèœ•å˜è¿›åº¦</h3>
                
                <!-- è¿›åº¦æ¡ -->
                <div class="w-full max-w-[200px] bg-slate-200 rounded-full h-2 mb-6">
                    <div class="bg-gradient-to-r from-indigo-500 to-teal-400 h-2 rounded-full transition-all duration-1000" :style="{width: progressPercent + '%'}"></div>
                </div>

                <!-- æ ¸å¿ƒè§†è§‰ï¼šè„‚åŒ…è‚Œæ¨¡å‹ -->
                <div class="body-container">
                    <!-- 1. åº•å±‚ï¼šè‚Œè‚‰äºº (ç›®æ ‡çŠ¶æ€) -->
                    <!-- å§‹ç»ˆæ˜¾ç¤ºï¼Œä½†åœ¨è„‚è‚ªå±‚ä¸‹é¢ -->
                    <svg class="body-layer" viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="muscleGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- å¤´ -->
                        <circle cx="50" cy="25" r="12" fill="#d97706" />
                        <!-- å€’ä¸‰è§’èº«ä½“ (å®½è‚©çª„è…°) -->
                        <path d="M25 45 L75 45 L60 100 L65 180 L55 180 L50 110 L45 180 L35 180 L40 100 L25 45 Z" fill="url(#muscleGradient)" />
                        <!-- è…¹è‚Œçº¿æ¡ç¤ºæ„ -->
                        <path d="M40 60 L60 60 M42 70 L58 70 M45 80 L55 80" stroke="rgba(255,255,255,0.5)" stroke-width="2" />
                    </svg>

                    <!-- 2. é¡¶å±‚ï¼šè„‚è‚ªå±‚ (åˆå§‹çŠ¶æ€) -->
                    <!-- é€æ˜åº¦éšè¿›åº¦é™ä½ï¼Œå®½åº¦éšè¿›åº¦æ”¶ç¼© -->
                    <svg class="body-layer" 
                         :style="{ 
                             opacity: (100 - progressPercent) / 100,
                             transform: `scaleX(${1 + (100 - progressPercent)/300})` 
                         }" 
                         viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- å¤´ -->
                        <circle cx="50" cy="25" r="13" fill="#cbd5e1" />
                        <!-- åœ†æ¶¦èº«ä½“ (Oå‹) -->
                        <path d="M30 50 Q15 90 30 130 L35 180 L45 180 L48 120 L52 120 L55 180 L65 180 L70 130 Q85 90 70 50 Z" fill="#e2e8f0" stroke="#94a3b8" stroke-width="1"/>
                    </svg>
                </div>

                <!-- æ•°æ®æ ‡ç­¾ -->
                <div class="mt-6 text-center z-10">
                    <p class="text-3xl font-bold text-slate-800">{{ currentWeight }} <span class="text-sm text-slate-500">kg</span></p>
                    <p class="text-sm text-slate-500 mt-1">
                        å·²å‡ <span class="text-teal-600 font-bold">{{ lostJin }}</span> æ–¤ / 
                        è¿˜å‰© <span class="text-rose-500 font-bold">{{ remainingJin }}</span> æ–¤
                    </p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè¶‹åŠ¿å›¾è¡¨ (å 4åˆ—) -->
        <div class="lg:col-span-4 flex flex-col">
            <div class="glass-panel rounded-2xl p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="font-bold text-slate-800">è¶‹åŠ¿åˆ†æ</h3>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">åŒæŒ‡/æ»šè½®ç¼©æ”¾</span>
                </div>
                
                <!-- å›¾è¡¨å®¹å™¨ -->
                <div v-if="records.length > 0" id="mainChart" class="w-full flex-1 min-h-[300px] rounded-xl"></div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300 min-h-[300px] border-2 border-dashed border-slate-200 rounded-xl">
                    <i class="fas fa-chart-area text-4xl mb-2"></i>
                    <p class="text-sm">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ‰“å¡</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ï¼šè¯¦ç»†åˆ—è¡¨ -->
    <section class="mt-6 glass-panel rounded-2xl p-6 overflow-hidden">
        <h3 class="text-lg font-bold text-slate-800 mb-4">è¯¦ç»†è®°å½•</h3>
        <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 shadow-sm">
                    <tr class="text-xs text-slate-400">
                        <th class="py-3 pl-4">æ—¥æœŸ</th>
                        <th class="py-3">ä½“é‡</th>
                        <th class="py-3">å˜åŒ–</th>
                        <th class="py-3">èŠ±è´¹</th>
                        <th class="py-3 text-right pr-4">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="text-sm text-slate-600">
                    <tr v-for="(record, index) in sortedRecords" :key="index" class="border-b border-slate-50 hover:bg-slate-50">
                        <td class="py-3 pl-4 font-mono">{{ record.date }}</td>
                        <td class="py-3 font-bold">{{ record.weight }}</td>
                        <td class="py-3">
                            <span :class="getChangeClass(index)">{{ getChange(index) }}</span>
                        </td>
                        <td class="py-3 text-slate-400">Â¥{{ record.cost }}</td>
                        <td class="py-3 text-right pr-4">
                            <button @click="deleteRecord(record.id)" class="text-rose-300 hover:text-rose-500 transition">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

</div>

<script>
const { createApp } = Vue;

const app = createApp({
    data() {
        return {
            settings: { initialWeight: 80, targetWeight: 65 },
            newRecord: { date: new Date().toISOString().split('T')[0], weight: '', cost: '' },
            records: [],
            chartInstance: null
        }
    },
    computed: {
        sortedRecords() { return [...this.records].sort((a, b) => new Date(b.date) - new Date(a.date)); },
        timelineRecords() { return [...this.records].sort((a, b) => new Date(a.date) - new Date(b.date)); },
        currentWeight() {
            if (this.records.length === 0) return this.settings.initialWeight;
            return this.timelineRecords[this.timelineRecords.length - 1].weight;
        },
        lostJin() {
            let lost = (this.settings.initialWeight - this.currentWeight) * 2;
            return lost > 0 ? lost.toFixed(1) : 0;
        },
        remainingJin() {
            let rem = (this.currentWeight - this.settings.targetWeight) * 2;
            return rem > 0 ? rem.toFixed(1) : 0;
        },
        totalCost() { return this.records.reduce((sum, r) => sum + (r.cost || 0), 0); },
        costPerJin() {
            const lost = parseFloat(this.lostJin);
            return (lost > 0) ? (this.totalCost / lost).toFixed(1) : "0.0";
        },
        progressPercent() {
            const totalToLose = this.settings.initialWeight - this.settings.targetWeight;
            const alreadyLost = this.settings.initialWeight - this.currentWeight;
            if (totalToLose <= 0) return 100;
            let pct = (alreadyLost / totalToLose) * 100;
            return Math.min(Math.max(pct, 0), 100).toFixed(1);
        }
    },
    mounted() {
        this.loadData();
        window.addEventListener('resize', () => {
            this.chartInstance && this.chartInstance.resize();
        });
    },
    methods: {
        saveSettings() {
            this.saveData();
            alert('ğŸ¯ ç›®æ ‡å·²æ›´æ–°ï¼å›¾è¡¨å’Œæ¨¡å‹å·²é‡ç½®ã€‚');
        },
        addRecord() {
            if (!this.newRecord.weight || !this.newRecord.date) return;
            const existingIndex = this.records.findIndex(r => r.date === this.newRecord.date);
            const record = { id: Date.now(), date: this.newRecord.date, weight: this.newRecord.weight, cost: this.newRecord.cost || 0 };
            
            if (existingIndex !== -1) {
                if(!confirm('è¦†ç›–å½“å¤©è®°å½•ï¼Ÿ')) return;
                this.records[existingIndex] = record;
            } else {
                this.records.push(record);
            }
            this.saveData();
            this.newRecord.cost = '';
        },
        deleteRecord(id) {
            if(confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) {
                this.records = this.records.filter(r => r.id !== id);
                this.saveData();
            }
        },
        resetData() {
            if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) {
                this.records = [];
                this.saveData();
            }
        },
        getChange(index) {
            const current = this.sortedRecords[index];
            const prev = this.sortedRecords[index + 1];
            let diff = prev ? (prev.weight - current.weight) * 2 : (this.settings.initialWeight - current.weight) * 2;
            if (diff === 0) return '-';
            return (diff > 0 ? 'â†“ ' : 'â†‘ ') + Math.abs(diff).toFixed(1);
        },
        getChangeClass(index) {
            const val = parseFloat(this.getChange(index).replace(/[â†“â†‘ ]/g, ''));
            const isDown = this.getChange(index).includes('â†“');
            if (isNaN(val) || val === 0) return 'text-slate-400';
            return isDown ? 'text-teal-500 font-bold' : 'text-rose-500 font-bold';
        },
        saveData() {
            localStorage.setItem('weightTrackerData', JSON.stringify({ settings: this.settings, records: this.records }));
            // ä½¿ç”¨ nextTick ç¡®ä¿ DOM æ›´æ–°åå†æ¸²æŸ“å›¾è¡¨
            this.$nextTick(() => {
                this.initChart();
            });
        },
        loadData() {
            try {
                const saved = localStorage.getItem('weightTrackerData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.settings = parsed.settings || this.settings;
                    this.records = parsed.records || [];
                }
            } catch (e) {}
            this.$nextTick(() => {
                this.initChart();
            });
        },
        initChart() {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä¸æ¸²æŸ“å›¾è¡¨ï¼Œé¿å…æŠ¥é”™
            if (this.records.length === 0) {
                if(this.chartInstance) {
                    this.chartInstance.dispose();
                    this.chartInstance = null;
                }
                return;
            }

            const chartDom = document.getElementById('mainChart');
            if (!chartDom) return; // é˜²æ­¢DOMæœªæ‰¾åˆ°

            if (!this.chartInstance) {
                this.chartInstance = echarts.init(chartDom);
            }

            const data = this.timelineRecords;
            const dates = data.map(r => r.date);
            const weights = data.map(r => r.weight);
            
            const option = {
                tooltip: { trigger: 'axis' },
                grid: { left: '10%', right: '10%', bottom: '10%', top: '15%' },
                xAxis: { type: 'category', data: dates, boundaryGap: false },
                yAxis: { 
                    type: 'value', 
                    scale: true, // ä¸ä»0å¼€å§‹
                    splitLine: { lineStyle: { type: 'dashed' } }
                },
                series: [{
                    name: 'ä½“é‡',
                    type: 'line',
                    smooth: true,
                    data: weights,
                    itemStyle: { color: '#6366f1' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(99, 102, 241, 0.4)' },
                            { offset: 1, color: 'rgba(99, 102, 241, 0.0)' }
                        ])
                    },
                    markLine: {
                        data: [{ yAxis: this.settings.targetWeight, name: 'ç›®æ ‡' }],
                        lineStyle: { color: '#14b8a6', type: 'dashed' }
                    }
                }]
            };
            this.chartInstance.setOption(option);
        },
        downloadTemplate() {
            const ws = XLSX.utils.json_to_sheet([{ "æ—¥æœŸ": "2023-10-01", "ä½“é‡": 75.5, "èŠ±è´¹": 0 }]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "å‡é‡è®°å½•æ¨¡æ¿.xlsx");
        },
        importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const jsonSheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    let count = 0;
                    jsonSheet.forEach(row => {
                        // ç®€å•æ¨¡ç³ŠåŒ¹é…
                        let d = row['æ—¥æœŸ'] || row['date'] || row['Date'];
                        let w = row['ä½“é‡'] || row['weight'] || row['Weight'];
                        let c = row['èŠ±è´¹'] || row['cost'] || row['Cost'] || 0;
                        
                        if (d && w) {
                            let dateStr = (d instanceof Date) ? 
                                new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().split('T')[0] : 
                                new Date(d).toISOString().split('T')[0];
                            
                            this.records.push({ id: Date.now() + Math.random(), date: dateStr, weight: parseFloat(w), cost: parseFloat(c) });
                            count++;
                        }
                    });
                    
                    // å»é‡
                    const map = new Map();
                    this.records.forEach(r => map.set(r.date, r));
                    this.records = Array.from(map.values());
                    
                    this.saveData();
                    alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡æ•°æ®`);
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
    }
});

app.mount('#app');
</script>
</body>
</html>
