<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾ç¾ä½“é‡è¿½è¸ªä¸è´¹ç”¨è®¡ç®—</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* æ•´ä½“å¸ƒå±€å’Œä¸»é¢˜ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #eef2f7;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        h2 {
            text-align: center;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* è¾“å…¥/æ§åˆ¶åŒºåŸŸ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        .input-group {
            flex-grow: 1;
            min-width: 150px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .input-group input[type="number"], .input-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            border-color: #007bff;
            outline: none;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            align-self: flex-end; /* ä½¿æŒ‰é’®å¯¹é½åº•éƒ¨ */
        }
        button:hover {
            background-color: #1e7e34;
        }

        /* ç»“æœå±•ç¤º */
        .summary-box {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 20px 0;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            color: #007bff;
        }
        .summary-value {
            font-size: 1.3em; 
            font-weight: bold;
            color: #333;
        }

        /* è®°å½•è¡¨æ ¼ */
        #history {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }
        #history th, #history td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: center;
        }
        #history th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        #chart-area {
            height: 400px;
            padding: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ‹ï¸ ä½“é‡ç›®æ ‡è¿½è¸ªä¸èŠ±è´¹è®¡ç®—</h2>

        <div class="controls">
            <div class="input-group">
                <label for="initialWeight">åˆå§‹ä½“é‡ (å…¬æ–¤):</label>
                <input type="number" id="initialWeight" value="70" min="1" step="0.1" onchange="saveInitialTarget()">
            </div>
            <div class="input-group">
                <label for="targetWeight">ç›®æ ‡ä½“é‡ (å…¬æ–¤):</label>
                <input type="number" id="targetWeight" value="60" min="1" step="0.1" onchange="saveInitialTarget()">
            </div>
            <div class="input-group">
                <label for="dailyCost">å¹³å‡æ¯æ—¥èŠ±è´¹ (å…ƒ):</label>
                <input type="number" id="dailyCost" value="120" min="0" step="1" onchange="saveInitialTarget()">
            </div>
            <div class="input-group">
                <label for="currentDate">è®°å½•æ—¥æœŸ:</label>
                <input type="date" id="currentDate">
            </div>
            <div class="input-group">
                <label for="currentWeight">ä»Šæ—¥ä½“é‡ (å…¬æ–¤):</label>
                <input type="number" id="currentWeight" value="65" min="1" step="0.1">
            </div>
            <button onclick="addWeightRecord()">è®°å½•å¹¶è®¡ç®—</button>
        </div>

        <div class="summary-box" id="summaryBox">
            </div>

        <div>
            <h3>ğŸ“ˆ ä½“é‡å˜åŒ–è¶‹åŠ¿ (æ–¤)</h3>
            <div id="chart-area">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div>
            <h3>ğŸ“‹ å†å²è®°å½• (æ–¤/å…¬æ–¤)</h3>
            <table id="history">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>ä½“é‡ (å…¬æ–¤)</th>
                        <th>ä½“é‡ (æ–¤)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    </tbody>
            </table>
        </div>
        
    </div>

    <script>
        const INITIAL_KEY = 'weightTracker_Initial';
        const TARGET_KEY = 'weightTracker_Target';
        const RECORDS_KEY = 'weightTracker_Records';
        const COST_KEY = 'weightTracker_Cost'; // ç”¨äºä¿å­˜æ¯æ—¥èŠ±è´¹çš„é”®
        let chart; 

        // --- 1. æ•°æ®åŠ è½½ä¸ä¿å­˜ ---

        // ä» Local Storage åŠ è½½åˆå§‹/ç›®æ ‡ä½“é‡å’ŒèŠ±è´¹
        function loadInitialTarget() {
            const initial = localStorage.getItem(INITIAL_KEY);
            const target = localStorage.getItem(TARGET_KEY);
            const cost = localStorage.getItem(COST_KEY);

            document.getElementById('initialWeight').value = initial || '70';
            document.getElementById('targetWeight').value = target || '60';
            document.getElementById('dailyCost').value = cost || '120'; // åŠ è½½æ¯æ—¥èŠ±è´¹
        }

        // ä¿å­˜åˆå§‹/ç›®æ ‡ä½“é‡å’ŒèŠ±è´¹
        function saveInitialTarget() {
            const initial = document.getElementById('initialWeight').value;
            const target = document.getElementById('targetWeight').value;
            const cost = document.getElementById('dailyCost').value;
            
            localStorage.setItem(INITIAL_KEY, initial);
            localStorage.setItem(TARGET_KEY, target);
            localStorage.setItem(COST_KEY, cost); // ä¿å­˜æ¯æ—¥èŠ±è´¹
            
            renderAll(); 
        }

        // åŠ è½½æ¯æ—¥è®°å½•
        function loadRecords() {
            const recordsJson = localStorage.getItem(RECORDS_KEY);
            // è¿”å›ä¸€ä¸ªæŒ‰æ—¥æœŸæ’åºçš„æ•°ç»„
            return recordsJson ? JSON.parse(recordsJson).sort((a, b) => new Date(a.date) - new Date(b.date)) : [];
        }

        // ä¿å­˜æ¯æ—¥è®°å½•
        function saveRecords(records) {
            localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
        }

        // --- 2. æ ¸å¿ƒè®¡ç®—ä¸è®°å½• ---

        function addWeightRecord() {
            const date = document.getElementById('currentDate').value;
            const weightKg = parseFloat(document.getElementById('currentWeight').value);

            if (!date || isNaN(weightKg) || weightKg <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œä½“é‡ï¼');
                return;
            }

            let records = loadRecords();
            const existingIndex = records.findIndex(r => r.date === date);

            if (existingIndex !== -1) {
                records[existingIndex].weightKg = weightKg;
            } else {
                records.push({ date, weightKg });
            }

            saveRecords(records);
            renderAll();
        }

        function deleteRecord(date) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${date} çš„ä½“é‡è®°å½•å—ï¼Ÿ`)) return;

            let records = loadRecords();
            records = records.filter(r => r.date !== date);
            saveRecords(records);
            renderAll();
        }

        // --- 3. æ¸²æŸ“å†å²è®°å½•è¡¨æ ¼ ---

        function renderHistoryTable(records) {
            const body = document.getElementById('historyBody');
            body.innerHTML = ''; 

            records.forEach(record => {
                const weightJin = record.weightKg * 2;
                const row = body.insertRow();
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.weightKg.toFixed(1)}</td>
                    <td>${weightJin.toFixed(1)}</td>
                    <td><button class="delete-btn" onclick="deleteRecord('${record.date}')">åˆ é™¤</button></td>
                `;
            });
        }

        // --- 4. æ¸²æŸ“æ±‡æ€»æ•°æ® ---

        function renderSummary(records) {
            const initialKg = parseFloat(document.getElementById('initialWeight').value);
            const targetKg = parseFloat(document.getElementById('targetWeight').value);
            const dailyCost = parseFloat(document.getElementById('dailyCost').value); // è·å–æ¯æ—¥èŠ±è´¹
            const summaryBox = document.getElementById('summaryBox');
            summaryBox.innerHTML = '';

            if (records.length === 0 || isNaN(initialKg) || isNaN(targetKg)) {
                summaryBox.innerHTML = '<p style="text-align:center;">è¯·å…ˆå½•å…¥åˆå§‹ä½“é‡ã€ç›®æ ‡ä½“é‡å’Œæ¯æ—¥è®°å½•ã€‚</p>';
                return;
            }

            const latestKg = records[records.length - 1].weightKg;
            const totalLossTarget = Math.abs(initialKg - targetKg);
            const currentLossKg = initialKg - latestKg; // æ­£æ•°è¡¨ç¤ºå‡é‡ï¼Œè´Ÿæ•°è¡¨ç¤ºå¢é‡
            const currentLossJin = currentLossKg * 2;
            
            const isLosingWeight = initialKg > targetKg;
            const diffSign = currentLossJin >= 0 ? 'å‡å°‘' : 'å¢åŠ ';

            let progressPercent = 0;
            if (totalLossTarget > 0) {
                // ä»…åœ¨ç›®æ ‡å’Œå®é™…å˜åŒ–æ–¹å‘ä¸€è‡´æ—¶è®¡ç®—è¿›åº¦
                if (isLosingWeight && currentLossKg >= 0 || !isLosingWeight && currentLossKg <= 0) {
                    progressPercent = (Math.abs(currentLossKg) / totalLossTarget) * 100;
                    progressPercent = Math.min(100, Math.max(0, progressPercent)); 
                }
            }

            // è®¡ç®—é¢„è®¡è¾¾æˆæ—¶é—´å’Œè´¹ç”¨
            let expectedDaysToTarget = 'N/A';
            let costPerJin = 'N/A';
            let totalDays = 0;

            if (records.length >= 2) {
                const firstRecord = records[0];
                const lastRecord = records[records.length - 1];
                
                // è®¡ç®—ä»ç¬¬ä¸€æ¬¡è®°å½•åˆ°æœ€åä¸€æ¬¡è®°å½•ä¹‹é—´çš„å¤©æ•°
                const timeDiff = new Date(lastRecord.date) - new Date(firstRecord.date);
                totalDays = Math.round(timeDiff / (1000 * 3600 * 24)); 

                if (totalDays > 0) {
                    const absCurrentLossKg = Math.abs(currentLossKg);

                    // 1. é¢„è®¡è¾¾æˆå¤©æ•°è®¡ç®—
                    if (absCurrentLossKg > 0) {
                        const averageDailyChange = absCurrentLossKg / totalDays; 
                        const remainingLossKg = Math.abs(targetKg - latestKg);
                        
                        if (remainingLossKg > 0 && averageDailyChange > 0) {
                            expectedDaysToTarget = Math.ceil(remainingLossKg / averageDailyChange) + ' å¤©';
                        } else if (remainingLossKg <= 0) {
                            expectedDaysToTarget = 'å·²è¾¾æˆï¼';
                        }
                    }

                    // 2. æ¯æ–¤èŠ±è´¹è®¡ç®—
                    const totalCost = totalDays * dailyCost;
                    if (absCurrentLossKg > 0 && totalCost > 0) {
                        const absCurrentLossJin = absCurrentLossKg * 2;
                        costPerJin = (totalCost / absCurrentLossJin).toFixed(2) + ' å…ƒ';
                    } else if (dailyCost === 0) {
                        costPerJin = '0.00 å…ƒ';
                    }
                }
            }


            summaryBox.innerHTML = `
                <div class="summary-item">
                    <h4>ä»Šæ—¥ä½“é‡</h4>
                    <span class="summary-value">${latestKg.toFixed(1)} å…¬æ–¤ (${(latestKg * 2).toFixed(1)} æ–¤)</span>
                </div>
                <div class="summary-item">
                    <h4>æ€»${diffSign}</h4>
                    <span class="summary-value" style="color: ${currentLossJin >= 0 ? '#28a745' : '#dc3545'};">${Math.abs(currentLossJin).toFixed(1)} æ–¤</span>
                </div>
                <div class="summary-item">
                    <h4>ç›®æ ‡è¿›åº¦</h4>
                    <span class="summary-value" style="color: ${progressPercent >= 100 ? '#28a745' : '#007bff'};">${progressPercent.toFixed(1)}%</span>
                </div>
                <div class="summary-item">
                    <h4>é¢„è®¡è¾¾æˆ</h4>
                    <span class="summary-value">${expectedDaysToTarget}</span>
                </div>
                <div class="summary-item">
                    <h4>æ¯æ–¤èŠ±è´¹</h4>
                    <span class="summary-value">${costPerJin}</span>
                </div>
            `;
        }

        // --- 5. Chart.js å¯è§†åŒ– ---

        function renderChart(records) {
            const initialKg = parseFloat(document.getElementById('initialWeight').value);
            const targetKg = parseFloat(document.getElementById('targetWeight').value);
            
            const labels = records.map(r => r.date);
            const dataJin = records.map(r => r.weightKg * 2);

            const ctx = document.getElementById('weightChart').getContext('2d');

            if (chart) {
                chart.destroy(); 
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å®é™…ä½“é‡ (æ–¤)',
                        data: dataJin,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        tension: 0.3, 
                        fill: true,
                    },
                    {
                        label: 'ç›®æ ‡ä½“é‡ (æ–¤)',
                        data: Array(labels.length).fill(targetKg * 2),
                        borderColor: '#28a745',
                        borderDash: [5, 5], 
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                    },
                    {
                        label: 'åˆå§‹ä½“é‡ (æ–¤)',
                        data: Array(labels.length).fill(initialKg * 2),
                        borderColor: '#dc3545',
                        borderDash: [5, 5], 
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'ä½“é‡ (æ–¤)', 
                                font: { size: 14, weight: 'bold' }
                            },
                            beginAtZero: false
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const kg = (context.parsed.y / 2).toFixed(1);
                                        label += `${context.parsed.y.toFixed(1)} æ–¤ (${kg} å…¬æ–¤)`; 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- 6. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---

        function renderAll() {
            const records = loadRecords();
            renderHistoryTable(records);
            renderSummary(records);
            renderChart(records);
        }

        // --- 7. åˆå§‹åŒ– ---

        window.onload = function() {
            // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤å€¼
            document.getElementById('currentDate').valueAsDate = new Date();
            loadInitialTarget(); // åŠ è½½åˆå§‹ã€ç›®æ ‡ä½“é‡å’ŒèŠ±è´¹
            renderAll(); // æ¸²æŸ“æ‰€æœ‰å†…å®¹
        };
    </script>

</body>
</html>