<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ ä½“é‡è¿½è¸ªã€æ±½è½¦è¡Œé©¶è¿›åº¦ä¸ Excel å¯¼å…¥ (å«æ¯æ—¥èŠ±è´¹)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* åŸºç¡€æ ·å¼ (å¤§éƒ¨åˆ†ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #eef2f7;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        h2 {
            text-align: center;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* å¸ƒå±€ */
        .top-section {
            display: grid;
            grid-template-columns: 2fr 1fr; 
            gap: 30px;
        }

        /* è¾“å…¥/æ§åˆ¶åŒºåŸŸ */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        .input-group {
            flex-grow: 1;
            min-width: 150px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            align-self: flex-end; 
        }
        button:hover {
            background-color: #1e7e34;
        }
        
        .import-group {
            min-width: 100%;
            border: 1px dashed #007bff;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        /* æ±‡æ€»æ•°æ®æ ·å¼ */
        .summary-box {
            display: flex;
            justify-content: space-around;
            text-align: center;
            padding: 20px 0;
            border-top: 1px dashed #ccc;
            border-bottom: 1px dashed #ccc;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            color: #007bff;
        }
        .summary-value {
            font-size: 1.3em; 
            font-weight: bold;
            color: #333;
        }
        
        /* --- æ±½è½¦è¿›åº¦å¯è§†åŒ– CSS --- */
        .road-visualization {
            background-color: #f0f0f5;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        #roadContainer {
            position: relative;
            width: 100%;
            height: 100px; 
            background: linear-gradient(to top, #333 70%, #666 100%); 
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .road-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 5px;
            background: repeating-linear-gradient(to right, 
                #ffcc00 0, 
                #ffcc00 20px, 
                transparent 20px, 
                transparent 40px); 
            transform: translateY(-50%);
        }
        
        #targetFlag {
            position: absolute;
            height: 100px;
            width: 5px;
            background-color: #28aa46; 
            right: 0;
            top: 0;
            transform: translateX(0px); 
            z-index: 10;
        }
        #targetFlag::before {
            content: 'ç»ˆç‚¹ç›®æ ‡';
            position: absolute;
            top: 0;
            right: 5px;
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            white-space: nowrap;
        }

        #carIcon {
            position: absolute;
            bottom: 10px; 
            left: 0;
            width: 60px;
            height: 30px;
            transition: left 1s ease-out; 
            z-index: 20;
            transform: translateX(-50%); 
        }
        
        .car-svg {
            fill: #dc3545; 
            stroke: #333;
            stroke-width: 1;
        }
        .wheel {
            fill: #333;
        }
        
        /* --- ç™»å½•ç•Œé¢æ ·å¼ --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .login-box {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        .login-box input[type="password"] {
            padding: 10px;
            margin: 10px 0 20px 0;
            width: 250px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.2em;
        }
        .login-box button {
            background-color: #007bff;
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
        }
        .login-box button:hover {
            background-color: #0056b3;
        }

        /* --- å¯†ç ç®¡ç†åŒºæ ·å¼ --- */
        .password-management {
            padding: 15px;
            border: 1px solid #ffc107;
            background-color: #fff3cd;
            border-radius: 10px;
            margin-top: 20px;
        }
        .password-management input {
            margin-right: 10px;
            padding: 8px;
            width: 120px;
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ” è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <input type="password" id="accessPassword" placeholder="è®¿é—®å¯†ç " required>
            <button onclick="checkPassword()">è®¿é—®åº”ç”¨</button>
            <p style="margin-top: 15px; color: #888;">åˆå§‹å¯†ç : 124578</p>
        </div>
    </div>
    
    <div class="container" id="mainApp" style="display:none;">
        <h2>ğŸ‹ï¸ ä½“é‡ç›®æ ‡è¿½è¸ªå™¨</h2>

        <div class="password-management">
            <h3>ğŸ”‘ å¯†ç ç®¡ç†</h3>
            <p>
                <label>ç®¡ç†å¯†ç :</label>
                <input type="password" id="adminPassword" placeholder="198666" style="width: 100px;">
                <label>æ–°è®¿é—®å¯†ç :</label>
                <input type="password" id="newAccessPassword" placeholder="æ–°å¯†ç ">
                <button onclick="changeAccessPassword()" style="background-color: #ffc107; color: #333; width: auto; padding: 8px 15px;">ä¿®æ”¹è®¿é—®å¯†ç </button>
            </p>
        </div>
        
        <div class="top-section">
            <div>
                <h3>âš™ï¸ åŸºç¡€ä¿¡æ¯å’Œè®°å½•</h3>
                <div class="controls">
                    <div class="input-group">
                        <label for="initialWeight">åˆå§‹ä½“é‡ (å…¬æ–¤):</label>
                        <input type="number" id="initialWeight" value="70" min="1" step="0.1" onchange="saveInitialTarget()">
                    </div>
                    <div class="input-group">
                        <label for="targetWeight">ç›®æ ‡ä½“é‡ (å…¬æ–¤):</label>
                        <input type="number" id="targetWeight" value="60" min="1" step="0.1" onchange="saveInitialTarget()">
                    </div>
                    <div class="input-group">
                        <label for="heightCm">èº«é«˜ (å˜ç±³):</label>
                        <input type="number" id="heightCm" value="170" min="100" step="1" onchange="saveInitialTarget()">
                    </div>
                    <div class="input-group">
                        <label for="gender">æ€§åˆ«:</label>
                        <select id="gender" onchange="saveInitialTarget()">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="currentDate">è®°å½•æ—¥æœŸ:</label>
                        <input type="date" id="currentDate">
                    </div>
                    <div class="input-group">
                        <label for="currentWeight">ä»Šæ—¥ä½“é‡ (å…¬æ–¤):</label>
                        <input type="number" id="currentWeight" value="65" min="1" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="currentDailyCost">ä»Šæ—¥èŠ±è´¹ (å…ƒ):</label>
                        <input type="number" id="currentDailyCost" value="120" min="0" step="1">
                    </div>
                    <button onclick="addWeightRecord()">è®°å½•å¹¶è®¡ç®—</button>

                    <div class="input-group import-group">
                        <label for="excelFile">ä» Excel/CSV å¯¼å…¥è®°å½• (.xlsx/.csv)</label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" onchange="importFromExcel(event)">
                        <small>æ ¼å¼è¦æ±‚ï¼š**æ—¥æœŸ** (Aåˆ—), **ä½“é‡** (Båˆ—), **æ¯æ—¥èŠ±è´¹** (Cåˆ—)</small>
                    </div>
                </div>
            </div>

            <div class="road-visualization">
                <h3>ğŸš— ç›®æ ‡é‡Œç¨‹è¿›åº¦</h3>
                <p id="progressInfo">å½“å‰è¿›åº¦: 0.0% | è·ç¦»ç›®æ ‡: N/A</p>
                
                <div id="roadContainer">
                    <div class="road-line"></div>
                    <div id="targetFlag"></div>
                    
                    <div id="carIcon">
                        <svg viewBox="0 0 60 30" class="car-svg">
                            <rect x="5" y="10" width="50" height="15" rx="5" class="car-svg"/>
                            <rect x="15" y="0" width="30" height="15" rx="5" class="car-svg"/>
                            <circle cx="15" cy="25" r="5" class="wheel"/>
                            <circle cx="45" cy="25" r="5" class="wheel"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="summary-box" id="summaryBox"></div>

        <div>
            <h3>ğŸ“ˆ ä½“é‡å˜åŒ–è¶‹åŠ¿ (æ–¤)</h3>
            <div id="chart-area">
                <canvas id="weightChart"></canvas>
            </div>
        </div>

        <div>
            <h3>ğŸ“‹ å†å²è®°å½• (æ–¤/å…¬æ–¤)</h3>
            <table id="history">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>ä½“é‡ (å…¬æ–¤)</th>
                        <th>ä½“é‡ (æ–¤)</th>
                        <th>èŠ±è´¹ (å…ƒ)</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
        
    </div>

    <script>
        // --- 0. å¸¸é‡å’Œå…¨å±€å˜é‡ ---
        const INITIAL_ACCESS_PASSWORD = '124578'; 
        const ADMIN_PASSWORD = '198666'; 
        const PASSWORD_KEY = 'weightTracker_AccessPassword'; 

        // åŸºç¡€æ•°æ®é”®
        const INITIAL_KEY = 'weightTracker_Initial';
        const TARGET_KEY = 'weightTracker_Target';
        const RECORDS_KEY = 'weightTracker_Records'; // è®°å½•ç°åœ¨åŒ…å«æ¯æ—¥èŠ±è´¹
        const GENDER_KEY = 'weightTracker_Gender';
        const HEIGHT_KEY = 'weightTracker_Height';
        let chart; 

        // --- A. å¯†ç æ§åˆ¶åŠŸèƒ½ (ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
        
        function getCurrentAccessPassword() {
            let password = localStorage.getItem(PASSWORD_KEY);
            if (!password) {
                password = INITIAL_ACCESS_PASSWORD;
                localStorage.setItem(PASSWORD_KEY, password);
            }
            return password;
        }

        function checkPassword() {
            const input = document.getElementById('accessPassword').value;
            const currentPassword = getCurrentAccessPassword();

            if (input === currentPassword) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'grid'; 
                initializeApp(); 
            } else {
                alert('å¯†ç é”™è¯¯ï¼è¯·é‡è¯•ã€‚');
                document.getElementById('accessPassword').value = '';
            }
        }

        function changeAccessPassword() {
            const adminInput = document.getElementById('adminPassword').value;
            const newPassInput = document.getElementById('newAccessPassword').value;

            if (adminInput !== ADMIN_PASSWORD) {
                alert('ç®¡ç†å¯†ç é”™è¯¯ï¼Œæ— æ³•ä¿®æ”¹è®¿é—®å¯†ç ï¼');
                return;
            }

            if (!newPassInput || newPassInput.length < 4) {
                alert('æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼Œä¸”å»ºè®®è‡³å°‘4ä½å­—ç¬¦ã€‚');
                return;
            }

            localStorage.setItem(PASSWORD_KEY, newPassInput);
            alert(`è®¿é—®å¯†ç ä¿®æ”¹æˆåŠŸï¼æ–°å¯†ç ä¸º: ${newPassInput}`);
            
            document.getElementById('adminPassword').value = '';
            document.getElementById('newAccessPassword').value = '';
        }

        // --- B. åº”ç”¨åˆå§‹åŒ– ---
        
        function initializeApp() {
            document.getElementById('currentDate').valueAsDate = new Date();
            loadInitialTarget(); 
            renderAll(); 
        }
        
        window.onload = function() {
            getCurrentAccessPassword(); 
            
            document.getElementById('accessPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        };

        // --- C. æ•°æ®åŠ è½½ä¸ä¿å­˜ (ä¿®æ”¹ï¼šä¸å†æœ‰å•ç‹¬çš„COST_KEY) ---
        
        function loadInitialTarget() {
            document.getElementById('initialWeight').value = localStorage.getItem(INITIAL_KEY) || '70';
            document.getElementById('targetWeight').value = localStorage.getItem(TARGET_KEY) || '60';
            // ç§»é™¤ load å¯¹ dailyCost çš„åŠ è½½ï¼Œç°åœ¨ä»è®°å½•ä¸­è·å–
            document.getElementById('gender').value = localStorage.getItem(GENDER_KEY) || 'male';
            document.getElementById('heightCm').value = localStorage.getItem(HEIGHT_KEY) || '170';
        }

        function saveInitialTarget() {
            localStorage.setItem(INITIAL_KEY, document.getElementById('initialWeight').value);
            localStorage.setItem(TARGET_KEY, document.getElementById('targetWeight').value);
            // ç§»é™¤å¯¹ dailyCost çš„ä¿å­˜
            localStorage.setItem(GENDER_KEY, document.getElementById('gender').value);
            localStorage.setItem(HEIGHT_KEY, document.getElementById('heightCm').value);
            renderAll(); 
        }

        function loadRecords() {
            const recordsJson = localStorage.getItem(RECORDS_KEY);
            return recordsJson ? JSON.parse(recordsJson).sort((a, b) => new Date(a.date) - new Date(b.date)) : [];
        }

        function saveRecords(records) {
            localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
        }

        // --- D. Excel/CSV å¯¼å…¥åŠŸèƒ½ (é‡å¤§ä¿®æ”¹ï¼šè¯»å–ç¬¬ä¸‰åˆ—æ¯æ—¥èŠ±è´¹) ---
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                let existingRecords = loadRecords();
                let importedCount = 0;
                
                json.forEach((row, index) => {
                    // å‡è®¾ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
                    if (index === 0 || !row[0] || !row[1]) return; 

                    let dateString = row[0];
                    let weightKg = parseFloat(row[1]);
                    // *** è¯»å–ç¬¬ä¸‰åˆ—æ•°æ® (æ¯æ—¥èŠ±è´¹) ***
                    let dailyCost = parseFloat(row[2]) || 0; // é»˜è®¤ä¸º 0ï¼Œä»¥é˜²æœªå¡«å†™

                    if (typeof dateString === 'number') {
                        const utc_days = Math.floor(dateString - 25569);
                        const date = new Date(utc_days * 86400 * 1000);
                        dateString = date.toISOString().split('T')[0];
                    }

                    if (dateString && !isNaN(weightKg) && weightKg > 0) {
                        const newRecord = { date: dateString, weightKg: weightKg, dailyCost: dailyCost };
                        
                        const existingIndex = existingRecords.findIndex(r => r.date === dateString);

                        if (existingIndex !== -1) {
                            existingRecords[existingIndex] = newRecord; 
                        } else {
                            existingRecords.push(newRecord); 
                        }
                        importedCount++;
                    }
                });
                
                if (importedCount > 0) {
                    saveRecords(existingRecords);
                    renderAll();
                    alert(`æˆåŠŸå¯¼å…¥/æ›´æ–°äº† ${importedCount} æ¡è®°å½•ï¼`);
                } else {
                    alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è®°å½•è¿›è¡Œå¯¼å…¥ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- E. è®°å½•ç®¡ç† (ä¿®æ”¹ï¼šæ•è·æ¯æ—¥èŠ±è´¹) ---
        function addWeightRecord() {
            const date = document.getElementById('currentDate').value;
            const weightKg = parseFloat(document.getElementById('currentWeight').value);
            // *** æ•è·æ‰‹åŠ¨è¾“å…¥çš„æ¯æ—¥èŠ±è´¹ ***
            const dailyCost = parseFloat(document.getElementById('currentDailyCost').value) || 0;

            if (!date || isNaN(weightKg) || weightKg <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸå’Œä½“é‡ï¼');
                return;
            }
            let records = loadRecords();
            const existingIndex = records.findIndex(r => r.date === date);

            const newRecord = { date, weightKg, dailyCost }; // åŒ…å«æ¯æ—¥èŠ±è´¹

            if (existingIndex !== -1) {
                // å¦‚æœå­˜åœ¨ï¼Œä¿ç•™æ—§è®°å½•ä¸­æœªè¾“å…¥çš„å­—æ®µ (æ­¤å¤„ä»…æ›´æ–°ä½“é‡å’ŒèŠ±è´¹)
                records[existingIndex] = Object.assign({}, records[existingIndex], newRecord);
            } else {
                records.push(newRecord);
            }

            saveRecords(records);
            renderAll();
        }

        function deleteRecord(date) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${date} çš„ä½“é‡è®°å½•å—ï¼Ÿ`)) return;

            let records = loadRecords();
            records = records.filter(r => r.date !== date);
            saveRecords(records);
            renderAll();
        }

        // --- F. æ¸²æŸ“æ±½è½¦å…¬è·¯å¯è§†åŒ– (ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ) ---
        function renderRoadVisualization(progressPercent, remainingLossJin) {
            const carIcon = document.getElementById('carIcon');
            const progressInfo = document.getElementById('progressInfo');
            
            const safeProgress = Math.min(100, Math.max(0, progressPercent));
            let carPosition = safeProgress;
            
            carIcon.style.left = `${carPosition}%`;

            let remainingText;
            if (safeProgress >= 100) {
                remainingText = "ç›®æ ‡å·²è¾¾æˆï¼";
                carIcon.style.fill = '#28a745'; 
            } else if (remainingLossJin === 'N/A') {
                remainingText = "N/A";
            } else {
                remainingText = `${remainingLossJin.toFixed(1)} æ–¤`;
                carIcon.style.fill = '#dc3545'; 
            }

            progressInfo.innerHTML = `å½“å‰è¿›åº¦: <strong>${safeProgress.toFixed(1)}%</strong> | è·ç¦»ç›®æ ‡: <strong>${remainingText}</strong>`;
        }

        // --- G. æ¸²æŸ“æ±‡æ€»æ•°æ® (é‡å¤§ä¿®æ”¹ï¼šè®¡ç®—æ€»èŠ±è´¹) ---
        function renderSummary(records) {
            const initialKg = parseFloat(document.getElementById('initialWeight').value);
            const targetKg = parseFloat(document.getElementById('targetWeight').value);
            
            const summaryBox = document.getElementById('summaryBox');
            summaryBox.innerHTML = '';

            if (records.length === 0 || isNaN(initialKg) || isNaN(targetKg)) {
                summaryBox.innerHTML = '<p style="text-align:center;">è¯·å…ˆå½•å…¥åˆå§‹ä½“é‡ã€ç›®æ ‡ä½“é‡å’Œæ¯æ—¥è®°å½•ã€‚</p>';
                renderRoadVisualization(0, 'N/A'); 
                return;
            }

            const latestKg = records[records.length - 1].weightKg;
            const totalLossTarget = Math.abs(initialKg - targetKg);
            const currentLossKg = initialKg - latestKg; 
            const currentLossJin = currentLossKg * 2; 
            
            const isLosingWeight = initialKg > targetKg;
            const diffSign = currentLossJin >= 0 ? 'å‡å°‘' : 'å¢åŠ ';

            let progressPercent = 0;
            if (totalLossTarget > 0) {
                if (isLosingWeight && currentLossKg >= 0 || !isLosingWeight && currentLossKg <= 0) {
                    progressPercent = (Math.abs(currentLossKg) / totalLossTarget) * 100;
                }
            }

            let expectedDaysToTarget = 'N/A';
            let costPerJin = 'N/A';
            let remainingLossJin = 'N/A';

            if (records.length >= 1) { // è‡³å°‘æœ‰ä¸€æ¡è®°å½•

                // *** æ€»èŠ±è´¹è®¡ç®—æ›´æ–° ***
                const totalCost = records.reduce((sum, record) => sum + (record.dailyCost || 0), 0);
                
                if (records.length >= 2) {
                    const firstRecord = records[0];
                    const lastRecord = records[records.length - 1];
                    
                    // è®¡ç®—ä»ç¬¬ä¸€æ¬¡è®°å½•åˆ°æœ€åä¸€æ¬¡è®°å½•ä¹‹é—´çš„å¤©æ•° (ç”¨äºå¹³å‡é€Ÿåº¦è®¡ç®—)
                    const timeDiff = new Date(lastRecord.date) - new Date(firstRecord.date);
                    const totalDays = Math.round(timeDiff / (1000 * 3600 * 24)); 
                    
                    const absCurrentLossKg = Math.abs(currentLossKg);
                    const remainingLossKg = Math.abs(targetKg - latestKg);
                    remainingLossJin = remainingLossKg * 2;
                    
                    if (totalDays > 0) {
                        // é¢„è®¡è¾¾æˆå¤©æ•°è®¡ç®—
                        if (absCurrentLossKg > 0) {
                            const averageDailyChange = absCurrentLossKg / totalDays; 
                            
                            if (remainingLossKg > 0 && averageDailyChange > 0) {
                                expectedDaysToTarget = Math.ceil(remainingLossKg / averageDailyChange) + ' å¤©';
                            } else if (remainingLossKg <= 0) {
                                expectedDaysToTarget = 'å·²è¾¾æˆï¼';
                            }
                        }
                    }
                }
                
                // æ¯æ–¤èŠ±è´¹è®¡ç®—
                const absCurrentLossKg = Math.abs(currentLossKg);
                if (absCurrentLossKg > 0 && totalCost > 0) {
                    const absCurrentLossJin = absCurrentLossKg * 2;
                    costPerJin = (totalCost / absCurrentLossJin).toFixed(2) + ' å…ƒ';
                } else if (totalCost === 0) {
                    costPerJin = '0.00 å…ƒ';
                }

            }
            
            renderRoadVisualization(progressPercent, remainingLossJin);

            summaryBox.innerHTML = `
                <div class="summary-item">
                    <h4>ä»Šæ—¥ä½“é‡</h4>
                    <span class="summary-value">${latestKg.toFixed(1)} å…¬æ–¤ (${(latestKg * 2).toFixed(1)} æ–¤)</span>
                </div>
                <div class="summary-item">
                    <h4>æ€»${diffSign}</h4>
                    <span class="summary-value" style="color: ${currentLossJin >= 0 ? '#28a745' : '#dc3545'};">${Math.abs(currentLossJin).toFixed(1)} æ–¤</span>
                </div>
                <div class="summary-item">
                    <h4>ç›®æ ‡è¿›åº¦</h4>
                    <span class="summary-value" style="color: ${progressPercent >= 100 ? '#28a745' : '#007bff'};">${Math.min(100, progressPercent).toFixed(1)}%</span>
                </div>
                <div class="summary-item">
                    <h4>é¢„è®¡è¾¾æˆ</h4>
                    <span class="summary-value">${expectedDaysToTarget}</span>
                </div>
                <div class="summary-item">
                    <h4>æ¯æ–¤èŠ±è´¹</h4>
                    <span class="summary-value">${costPerJin}</span>
                </div>
            `;
        }
        
        // --- H. æ¸²æŸ“è¡¨æ ¼å’Œå›¾è¡¨ (ä¿®æ”¹ï¼šè¡¨æ ¼å¢åŠ èŠ±è´¹åˆ—) ---
        function renderHistoryTable(records) {
            const body = document.getElementById('historyBody');
            body.innerHTML = ''; 

            records.forEach(record => {
                const weightJin = record.weightKg * 2;
                const dailyCost = (record.dailyCost || 0).toFixed(2);
                const row = body.insertRow();
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.weightKg.toFixed(1)}</td>
                    <td>${weightJin.toFixed(1)}</td>
                    <td>${dailyCost}</td> 
                    <td><button class="delete-btn" onclick="deleteRecord('${record.date}')">åˆ é™¤</button></td>
                `;
            });
        }

        function renderChart(records) {
            const initialKg = parseFloat(document.getElementById('initialWeight').value);
            const targetKg = parseFloat(document.getElementById('targetWeight').value);
            
            const labels = records.map(r => r.date);
            const dataJin = records.map(r => r.weightKg * 2);

            const ctx = document.getElementById('weightChart').getContext('2d');

            if (chart) {
                chart.destroy(); 
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å®é™…ä½“é‡ (æ–¤)',
                        data: dataJin,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        tension: 0.3, 
                        fill: true,
                    },
                    {
                        label: 'ç›®æ ‡ä½“é‡ (æ–¤)',
                        data: Array(labels.length).fill(targetKg * 2),
                        borderColor: '#28a745',
                        borderDash: [5, 5], 
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                    },
                    {
                        label: 'åˆå§‹ä½“é‡ (æ–¤)',
                        data: Array(labels.length).fill(initialKg * 2),
                        borderColor: '#dc3545',
                        borderDash: [5, 5], 
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'ä½“é‡ (æ–¤)', 
                                font: { size: 14, weight: 'bold' }
                            },
                            beginAtZero: false
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const kg = (context.parsed.y / 2).toFixed(1);
                                        label += `${context.parsed.y.toFixed(1)} æ–¤ (${kg} å…¬æ–¤)`; 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderAll() {
            const records = loadRecords();
            renderHistoryTable(records);
            renderSummary(records);
            renderChart(records);
        }

    </script>

</body>
</html>